name: X399 Hunter-Seeker (v2)
on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:        # Manual trigger via GitHub UI
    inputs:
      debug_mode:
        description: 'Enable verbose logging'
        required: false
        default: 'false'

jobs:
  hunt:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Needed to push JSON data back
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for price analysis

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          playwright install chromium --with-deps

      - name: Run Carousell scraper
        env:
          PROXY_URL: ${{ secrets.PROXY_URL }}
        run: |
          # The scraper script handles proxy parsing internally
          python scrapers/carousell.py --config config/targets.yaml \
            --output data/carousell/$(date +%Y-%m-%d_%H-%M).json

      - name: Analyze pricing (Z-score)
        run: |
          python analytics/zscore.py \
            --data-dir data/ \
            --lookback-days 30 \
            --output alerts/deals.json

      - name: Send Discord alerts
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          python alerts/discord.py --input alerts/deals.json

      - name: Save Raw Scrape Data (Artifacts)
        uses: actions/upload-artifact@v4
        with:
          name: raw-data-run-${{ github.run_number }}
          path: data/
          retention-days: 30

      - name: Commit Analysis Results Only
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add alerts/deals.json
          # Only commit if there are deals found
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ“Š Deals Found: $(date +%Y-%m-%d_%H-%M)" && git push)

      - name: Weekly Backup to Git LFS
        if: github.event.schedule == '0 0 * * 0'
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          # Archive all JSONs currently in data/
          tar -czf data_archive/weekly-$(date +%Y-%m-%d).tar.gz data/
          git lfs track "*.tar.gz"
          git add .gitattributes data_archive/
          git commit -m "ðŸ“¦ Weekly Data Backup"
          git push
